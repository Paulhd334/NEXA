<script>
    // Configuration
    const SUPABASE_URL = 'https://itnrlxfbejgxbibezoup.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0bnJseGZiZWpneGJpYmV6b3VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDgwODEsImV4cCI6MjA3NjUyNDA4MX0.0Ztl75n24jvOv0zGRvLSFGMmc0hQ3eoiZDwDrIrWKZ4';

    // Fonction pour afficher les messages d'alerte
    function showAlert(message, type) {
        const successAlert = document.getElementById('success-alert');
        const errorAlert = document.getElementById('error-alert');
        
        successAlert.style.display = 'none';
        errorAlert.style.display = 'none';
        
        if (type === 'success') {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
        } else {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
        }
    }

    // V√©rifier si l'email existe dans Supabase
    async function checkEmailExists(email) {
        try {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            console.log('üîç V√©rification email:', email);
            
            const { error } = await supabase.auth.signInWithPassword({
                email: email,
                password: 'temporary_check_password_' + Date.now()
            });

            if (error && error.message.includes('Invalid login credentials')) {
                console.log('‚úÖ Email trouv√© dans Supabase');
                return { exists: true };
            }
            
            console.log('‚ùå Email non trouv√© ou autre erreur:', error?.message);
            return { exists: false };
            
        } catch (error) {
            console.error('Erreur v√©rification email:', error);
            return { exists: false };
        }
    }

    // G√©n√©rer un token de r√©initialisation s√©curis√©
    function generateResetToken() {
        // Token plus long et s√©curis√©
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let token = '';
        for (let i = 0; i < 32; i++) {
            token += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return token;
    }

    // Cr√©er un hash simple pour la v√©rification
    function createVerificationHash(email, token) {
        return btoa(email + '|' + token + '|' + Date.now()).replace(/=/g, '');
    }

    // Envoyer l'email via ton API Brevo
    async function sendResetEmail(email) {
        try {
            const resetToken = generateResetToken();
            const verificationHash = createVerificationHash(email, resetToken);
            
            // TOKEN DANS L'URL - Solution 2
            const resetLink = `${window.location.origin}/account/update-password.html?token=${resetToken}&email=${encodeURIComponent(email)}&hash=${verificationHash}`;
            
            console.log('üì§ Envoi email √†:', email);
            console.log('üîó Lien g√©n√©r√©:', resetLink);

            const emailData = {
                email: email,
                reset_link: resetLink
            };

            // Appel √† ton endpoint API
            const response = await fetch('/api/send-reset-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(emailData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erreur API: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('‚úÖ R√©ponse API:', result);
            
            return { 
                success: true, 
                data: result,
                resetLink: resetLink // Pour debug
            };

        } catch (error) {
            console.error('‚ùå Erreur envoi email:', error);
            return { 
                success: false, 
                error: error.message 
            };
        }
    }

    // Gestionnaire du formulaire PRINCIPAL
    document.getElementById('reset-password-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value.trim();
        const submitBtn = document.getElementById('submit-btn');
        
        // Validation de base
        if (!email) {
            showAlert('Veuillez entrer votre adresse email.', 'error');
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showAlert('Veuillez entrer une adresse email valide.', 'error');
            return;
        }
        
        // D√©sactiver le bouton
        submitBtn.disabled = true;
        submitBtn.textContent = 'V√©rification...';
        
        try {
            // √âtape 1: V√©rifier si l'email existe
            console.log('üîÑ V√©rification du compte...');
            const emailCheck = await checkEmailExists(email);
            
            if (!emailCheck.exists) {
                showAlert('‚ùå Aucun compte trouv√© avec cet email.', 'error');
                return;
            }
            
            // √âtape 2: Envoyer l'email de r√©initialisation
            submitBtn.textContent = 'Envoi en cours...';
            console.log('üìß Envoi du lien de r√©initialisation...');
            
            const result = await sendResetEmail(email);
            
            if (result.success) {
                showAlert(`‚úÖ Un email de r√©initialisation a √©t√© envoy√© √† ${email}. V√©rifiez votre bo√Æte de r√©ception.`, 'success');
                document.getElementById('reset-password-form').reset();
                
                // Redirection vers la page de connexion apr√®s 3 secondes
                setTimeout(() => {
                    window.location.href = 'https://nexa-neon.vercel.app/login.html';
                }, 3000);
            } else {
                showAlert(`‚ùå Erreur: ${result.error}`, 'error');
            }
            
        } catch (error) {
            console.error('üí• Erreur g√©n√©rale:', error);
            showAlert('‚ùå Une erreur inattendue est survenue. Veuillez r√©essayer.', 'error');
        } finally {
            // R√©activer le bouton dans tous les cas
            submitBtn.disabled = false;
            submitBtn.textContent = 'Envoyer le lien de r√©initialisation';
        }
    });

    // Pr√©-remplir l'email si disponible
    document.addEventListener('DOMContentLoaded', function() {
        const savedEmail = localStorage.getItem('savedEmail');
        if (savedEmail) {
            document.getElementById('email').value = savedEmail;
        }
    });

    console.log('‚úÖ Syst√®me de reset password initialis√©');
</script>
